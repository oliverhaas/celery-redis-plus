{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"],"fields":{"title":{"boost":1000.0},"text":{"boost":1.0},"tags":{"boost":1000000.0}}},"docs":[{"location":"","title":"Celery Redis Plus","text":"<p>Enhanced Redis/Valkey transport for Celery/Kombu with native delayed delivery, improved reliability, full priority support, and reliable fanout.</p>"},{"location":"#overview","title":"Overview","text":"<p><code>celery-redis-plus</code> is a replacement Redis/Valkey transport for Celery that addresses key limitations of the standard transport:</p> <ol> <li>Native Delayed Delivery - Tasks with long <code>countdown</code> or <code>eta</code> are stored in Redis and delivered when due, instead of being held in worker memory.</li> <li>Improved Reliability - Atomic message consumption via BZMPOP with improvements regarding visibility timeout ensures zero message loss.</li> <li>Full Priority Support - All 256 priority levels (0-255) with RabbitMQ-compatible semantics (higher number = higher priority).</li> <li>Reliable Fanout - Redis Streams replace lossy PUB/SUB for durable broadcast event messaging.</li> </ol>"},{"location":"#requirements","title":"Requirements","text":"<p>We target recent versions for BZMPOP support and to simplify development.</p> <ul> <li>Python &gt;= 3.13</li> <li>Celery &gt;= 5.5.0</li> <li>Redis &gt;= 7.0 (for BZMPOP) or Valkey (any version)</li> </ul>"},{"location":"#how-it-works","title":"How It Works","text":""},{"location":"#sorted-set-queues","title":"Sorted Set Queues","text":"<p>Queues use Redis sorted sets instead of lists. Messages are added with <code>ZADD</code> using a score that encodes priority and timestamp. Workers use <code>BZMPOP</code> to atomically pop the highest-priority, oldest message.</p>"},{"location":"#message-persistence","title":"Message Persistence","text":"<p>Messages are stored in per-message hashes before being added to the queue. When consumed, the hash persists until explicitly acknowledged. Combined with visibility timeout tracking, this ensures messages are never lost - even if a worker crashes in the instant after the message is pop'ed from the queue, the message can be recovered and requeued.</p>"},{"location":"#delayed-delivery","title":"Delayed Delivery","text":"<p>Delayed messages are stored in a sorted set with timestamps as scores. A background thread periodically checks for messages whose timestamp has passed and moves them to the normal queue.</p>"},{"location":"#stream-based-fanout","title":"Stream-based Fanout","text":"<p>Fanout exchanges use Redis Streams. Messages are added with <code>XADD</code>, and each consumer uses <code>XREAD</code> tracking their own position. Old messages are trimmed based on <code>stream_maxlen</code>.</p>"},{"location":"#contributing","title":"Contributing","text":"<p>This package is intended as a temporary solution until these improvements are hopefully merged upstream into Celery/Kombu. Contributions are welcome!</p>"},{"location":"#license","title":"License","text":"<p>MIT License - see LICENSE for details.</p>"},{"location":"getting-started/installation/","title":"Installation","text":""},{"location":"getting-started/installation/#requirements","title":"Requirements","text":"<ul> <li>Python &gt;= 3.13</li> <li>Celery &gt;= 5.5.0</li> <li>Redis &gt;= 7.0 (for BZMPOP) or Valkey (any version)</li> </ul>"},{"location":"getting-started/installation/#install","title":"Install","text":"<pre><code>uv add celery-redis-plus\n</code></pre> <p>You'll also need a client library. Choose one:</p> <pre><code># For Valkey (recommended)\nuv add celery-redis-plus[valkey]\n\n# For Valkey with libvalkey C extension (faster)\nuv add celery-redis-plus[libvalkey]\n\n# For Redis\nuv add celery-redis-plus[redis]\n\n# For Redis with hiredis C extension (faster)\nuv add celery-redis-plus[hiredis]\n</code></pre>"},{"location":"getting-started/installation/#development-installation","title":"Development Installation","text":"<pre><code># Clone the repository\ngit clone https://github.com/oliverhaas/celery-redis-plus.git\ncd celery-redis-plus\n\n# Create virtual environment and install with development dependencies\nuv venv\nuv sync --group dev\n\n# Run tests (requires Docker for integration tests)\nuv run pytest\n\n# Run linter\nuv run ruff check\n\n# Run type checker\nuv run ty check\n</code></pre>"},{"location":"getting-started/migration/","title":"Migrating from Standard Redis Transport","text":"<p>The two transports use different Redis data structures (list vs sorted set), so existing tasks won't be picked up after switching. Use Celery's built-in migration to move them:</p> <pre><code>from celery import Celery\nfrom celery.contrib.migrate import migrate_tasks\n\n# Source: standard Redis transport (no broker_transport)\nsource_app = Celery(\"source\")\nsource_app.conf.broker_url = \"redis://localhost:6379/0\"\n\n# Destination: your app with celery-redis-plus\ndest_app = Celery(\"dest\")\ndest_app.conf.update(\n    broker_url=\"redis://localhost:6379/0\",\n    broker_transport=\"celery_redis_plus.transport:Transport\",\n)\n\n# Migrate\nwith source_app.connection() as src, dest_app.connection() as dst:\n    state = migrate_tasks(src, dst, app=dest_app, ack_messages=True)\n    print(f\"Migrated {state.count} tasks\")\n</code></pre> <p>The <code>dest_app</code> is probably just the app of your new deployment and does not need to be explicitely defined, while <code>source_app</code> is a temporary dummy app for the old transports.</p> <p>For most cases where a few minutes of task delays do not matter, the migration is fairly straight forward. Deploy new code with the backwards-compatible <code>source_app</code>, run the migration script, migration itself is already done, then remove the <code>source_app</code> or any other leftovers in the next deployment.</p>"},{"location":"getting-started/quickstart/","title":"Quick Start","text":""},{"location":"getting-started/quickstart/#basic-setup","title":"Basic Setup","text":"<pre><code>from celery import Celery\nfrom celery_redis_plus import DelayedDeliveryBootstep\n\napp = Celery('myapp')\n\n# For Valkey: use valkey:// URL scheme\napp.config_from_object({\n    'broker_url': 'valkey://localhost:6379/0',\n})\n\n# For Redis: use redis:// but with broker_transport,\n# since the official Redis transport is otherwise used.\n# app.config_from_object({\n#     'broker_url': 'redis://localhost:6379/0',\n#     'broker_transport': 'celery_redis_plus.transport:Transport',\n# })\n\napp.steps['consumer'].add(DelayedDeliveryBootstep)\n\n@app.task\ndef my_task():\n    print(\"Hello!\")\n\n# Use tasks as always\nmy_task.delay()\n\n# Tasks with countdown/eta will use native delayed delivery\nmy_task.apply_async(countdown=120)\n\n# Priority support (RabbitMQ semantics: higher = more important)\nmy_task.apply_async(priority=200)   # High priority\nmy_task.apply_async(priority=0)    # Low priority (default)\n</code></pre>"},{"location":"getting-started/quickstart/#example-project","title":"Example Project","text":"<p>See <code>examples/simple/</code> for a runnable example with Docker Compose, Flower, and tasks exercising all key features.</p>"},{"location":"getting-started/quickstart/#configuration","title":"Configuration","text":""},{"location":"getting-started/quickstart/#transport-options","title":"Transport Options","text":"<p>Configure via Celery's <code>broker_transport_options</code>. Many options are the same as in the official Redis transport:</p> <pre><code>app.config_from_object({\n    'broker_url': 'valkey://localhost:6379/0', # or valkeys:// for ssl\n    'broker_transport_options': {\n        'global_keyprefix': 'myapp:',        # Prefix for all Redis keys\n        'visibility_timeout': 300,           # Seconds before unacked messages are reclaimed\n        'stream_maxlen': 10000,              # Max messages per stream (approximate)\n    },\n})\n</code></pre>"},{"location":"reference/api/","title":"API Reference","text":""},{"location":"reference/api/#transport","title":"Transport","text":""},{"location":"reference/api/#celery_redis_plustransport","title":"<code>celery_redis_plus.Transport</code>","text":"<p>Custom transport with sorted set queues, priority encoding, delayed delivery, and Redis Streams fanout.</p> <p>Usage:</p> <pre><code># For Valkey\napp.config_from_object({\n    'broker_url': 'valkey://localhost:6379/0',\n})\n\n# For Redis\napp.config_from_object({\n    'broker_url': 'redis://localhost:6379/0',\n    'broker_transport': 'celery_redis_plus.transport:Transport',\n})\n</code></pre> <p>Features:</p> <ul> <li>Sorted set queues with <code>BZMPOP</code> for atomic consumption</li> <li>Full 256-level priority support (0-255, higher = more important)</li> <li>Native delayed delivery using sorted set timestamps</li> <li>Redis Streams for reliable fanout messaging</li> </ul>"},{"location":"reference/api/#bootstep","title":"Bootstep","text":""},{"location":"reference/api/#celery_redis_plusdelayeddeliverybootstep","title":"<code>celery_redis_plus.DelayedDeliveryBootstep</code>","text":"<p>Worker bootstep that integrates with the Celery consumer lifecycle.</p> <p>Usage:</p> <pre><code>from celery_redis_plus import DelayedDeliveryBootstep\n\napp.steps['consumer'].add(DelayedDeliveryBootstep)\n</code></pre> <p>Responsibilities:</p> <ul> <li>Signals transport when consumer starts/stops</li> <li>Enables native delayed delivery mode on the transport</li> </ul>"},{"location":"reference/api/#configuration-options","title":"Configuration Options","text":""},{"location":"reference/api/#broker_transport_options","title":"<code>broker_transport_options</code>","text":"<p>All options are passed via Celery's <code>broker_transport_options</code> configuration.</p>"},{"location":"reference/api/#core-options","title":"Core Options","text":"Option Type Default Description <code>visibility_timeout</code> <code>int</code> <code>300</code> Seconds before unacked messages are reclaimed <code>global_keyprefix</code> <code>str</code> <code>\"\"</code> Prefix for all Redis keys <code>stream_maxlen</code> <code>int</code> <code>10000</code> Max messages per fanout stream (approximate)"},{"location":"reference/api/#message-storage-options","title":"Message Storage Options","text":"Option Type Default Description <code>message_key_prefix</code> <code>str</code> <code>\"message:\"</code> Prefix for per-message hash keys <code>message_ttl</code> <code>int</code> <code>259200</code> TTL in seconds for message hashes (default: 3 days) <code>messages_index_prefix</code> <code>str</code> <code>\"messages_index:\"</code> Prefix for per-queue messages index sorted sets"},{"location":"reference/api/#connection-options","title":"Connection Options","text":"Option Type Default Description <code>socket_timeout</code> <code>float</code> <code>None</code> Socket timeout in seconds <code>socket_connect_timeout</code> <code>float</code> <code>None</code> Socket connection timeout in seconds <code>socket_keepalive</code> <code>bool</code> <code>None</code> Enable TCP keepalive <code>socket_keepalive_options</code> <code>dict</code> <code>None</code> TCP keepalive options <code>max_connections</code> <code>int</code> <code>10</code> Maximum connections in pool <code>health_check_interval</code> <code>int</code> <code>25</code> Health check interval in seconds <code>retry_on_timeout</code> <code>bool</code> <code>None</code> Retry on timeout <code>client_name</code> <code>str</code> <code>None</code> Redis client name for <code>CLIENT SETNAME</code> <code>ssl</code> <code>bool</code> or <code>dict</code> <code>None</code> SSL/TLS configuration"},{"location":"reference/api/#fanout-options","title":"Fanout Options","text":"Option Type Default Description <code>fanout_prefix</code> <code>bool</code> or <code>str</code> <code>True</code> Prefix for fanout streams (<code>True</code> uses <code>/{db}.</code>) <code>fanout_patterns</code> <code>bool</code> <code>True</code> Enable pattern-based fanout routing"},{"location":"reference/api/#advanced-options","title":"Advanced Options","text":"Option Type Default Description <code>sep</code> <code>str</code> <code>\"\\x06\\x16\"</code> Separator for binding key encoding"},{"location":"reference/api/#example-configuration","title":"Example Configuration","text":"<pre><code>app.config_from_object({\n    'broker_url': 'valkey://localhost:6379/0',\n    'broker_transport_options': {\n        'global_keyprefix': 'myapp:',\n        'visibility_timeout': 600,\n        'stream_maxlen': 50000,\n        'message_ttl': 86400,  # 1 day\n        'max_connections': 20,\n        'health_check_interval': 30,\n    },\n})\n</code></pre>"},{"location":"reference/api/#redis-keys","title":"Redis Keys","text":"<p>The transport uses the following Redis key patterns:</p> Pattern Type Description <code>queue:{name}</code> Sorted Set Queue storing delivery tags with priority+timestamp scores <code>message:{delivery_tag}</code> Hash Message payload, routing key, priority, and flags <code>messages_index:{name}</code> Sorted Set Per-queue index tracking <code>{delivery_tag: queue_at}</code> for visibility timeout and delayed delivery <code>/{db}.{exchange}</code> Stream Fanout messages <code>_kombu.binding.{exchange}</code> Set Queue-exchange bindings"},{"location":"reference/api/#constants","title":"Constants","text":"<p>The following constants are used internally and define default behavior:</p> Constant Value Description <code>DEFAULT_VISIBILITY_TIMEOUT</code> <code>300</code> Default visibility timeout (5 minutes) <code>DEFAULT_REQUEUE_CHECK_INTERVAL</code> <code>60</code> Interval for checking messages to requeue <code>DEFAULT_REQUEUE_BATCH_LIMIT</code> <code>1000</code> Max messages processed per requeue cycle <code>DEFAULT_STREAM_MAXLEN</code> <code>10000</code> Default max length for fanout streams <code>DEFAULT_MESSAGE_TTL</code> <code>259200</code> Default TTL for message hashes (3 days) <code>PRIORITY_SCORE_MULTIPLIER</code> <code>10^13</code> Multiplier for priority in score calculation <code>QUEUE_KEY_PREFIX</code> <code>\"queue:\"</code> Prefix for queue sorted sets <code>MESSAGE_KEY_PREFIX</code> <code>\"message:\"</code> Prefix for message hashes <code>MESSAGES_INDEX_PREFIX</code> <code>\"messages_index:\"</code> Prefix for per-queue message index sorted sets"},{"location":"reference/changelog/","title":"Changelog","text":"<p>All notable changes to this project will be documented in this file.</p> <p>The format is based on Keep a Changelog, and this project adheres to Semantic Versioning.</p>"},{"location":"reference/changelog/#unreleased","title":"[Unreleased]","text":""},{"location":"reference/changelog/#changed","title":"Changed","text":"<ul> <li>Split global <code>messages_index</code> sorted set into per-queue <code>messages_index:{queue}</code> keys for scoped recovery, clean queue lifecycle, and correct <code>global_keyprefix</code> behavior with Lua scripts</li> </ul>"},{"location":"reference/changelog/#025-2026-02-14","title":"[0.2.5] - 2026-02-14","text":""},{"location":"reference/changelog/#fixed","title":"Fixed","text":"<ul> <li>Fanout/broadcast (events, Flower) now works: added dedicated subclient for XREAD and fixed per-routing-key stream splitting</li> </ul>"},{"location":"reference/changelog/#added","title":"Added","text":"<ul> <li>Example project in <code>examples/simple/</code> demonstrating tasks, delayed delivery, priority, retries, and Flower</li> </ul>"},{"location":"reference/changelog/#024-2026-01-31","title":"[0.2.4] - 2026-01-31","text":""},{"location":"reference/changelog/#added_1","title":"Added","text":"<ul> <li>Migration support from standard Redis transport</li> </ul>"},{"location":"reference/changelog/#fixed_1","title":"Fixed","text":"<ul> <li>Simplified transport configuration in docs</li> </ul>"},{"location":"reference/changelog/#023-2026-01-29","title":"[0.2.3] - 2026-01-29","text":""},{"location":"reference/changelog/#added_2","title":"Added","text":"<ul> <li>Support for both redis-py and valkey-py client libraries (optional dependencies)</li> <li><code>valkey://</code> and <code>valkeys://</code> URL scheme support for easier configuration</li> <li>SSL/TLS detection from <code>valkeys://</code> URL scheme</li> <li>Priority clamping for out-of-range values (clamps to 0-255 range with warning)</li> </ul>"},{"location":"reference/changelog/#fixed_2","title":"Fixed","text":"<ul> <li>Documentation site 404 by setting dev as default version</li> </ul>"},{"location":"reference/changelog/#022-2025-01-22","title":"[0.2.2] - 2025-01-22","text":""},{"location":"reference/changelog/#changed_1","title":"Changed","text":"<ul> <li>Updated celery-types-ng to 0.25.4 and fixed typing errors</li> </ul>"},{"location":"reference/changelog/#021-2025-01-21","title":"[0.2.1] - 2025-01-21","text":""},{"location":"reference/changelog/#changed_2","title":"Changed","text":"<ul> <li>Added <code>queue:</code> prefix to avoid collision with list-based queues</li> </ul>"},{"location":"reference/changelog/#020-2025-01-20","title":"[0.2.0] - 2025-01-20","text":""},{"location":"reference/changelog/#added_3","title":"Added","text":"<ul> <li>Native delayed delivery support</li> <li>Full priority support (0-255)</li> <li>Reliable fanout via Redis Streams</li> <li>Visibility timeout tracking</li> </ul>"},{"location":"reference/changelog/#changed_3","title":"Changed","text":"<ul> <li>Switched from Redis lists to sorted sets for queues</li> <li>Improved message reliability with per-message hashes</li> </ul>"},{"location":"reference/changelog/#010-2025-01-15","title":"[0.1.0] - 2025-01-15","text":""},{"location":"reference/changelog/#added_4","title":"Added","text":"<ul> <li>Initial release</li> <li>Custom Kombu transport for Redis/Valkey</li> <li>Basic queue operations with sorted sets</li> </ul>"}]}