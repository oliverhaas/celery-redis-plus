{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"],"fields":{"title":{"boost":1000.0},"text":{"boost":1.0},"tags":{"boost":1000000.0}}},"docs":[{"location":"","title":"Celery Redis Plus","text":"<p>Enhanced Redis/Valkey transport for Celery with native delayed delivery, improved reliability, full priority support, and reliable fanout.</p>"},{"location":"#overview","title":"Overview","text":"<p><code>celery-redis-plus</code> is a replacement Redis/Valkey transport for Celery that addresses key limitations of the standard transport:</p> <ol> <li>Native Delayed Delivery - Tasks with long <code>countdown</code> or <code>eta</code> are stored in Redis and delivered when due, instead of being held in worker memory.</li> <li>Improved Reliability - Atomic message consumption via BZMPOP with improvements regarding visibility timeout ensures zero message loss.</li> <li>Full Priority Support - All 256 priority levels (0-255) with RabbitMQ-compatible semantics (higher number = higher priority).</li> <li>Reliable Fanout - Redis Streams replace lossy PUB/SUB for durable broadcast messaging.</li> </ol>"},{"location":"#requirements","title":"Requirements","text":"<p>We target recent versions for BZMPOP support and to simplify development.</p> <ul> <li>Python &gt;= 3.13</li> <li>Celery &gt;= 5.5.0</li> <li>Redis &gt;= 7.0 (for BZMPOP) or Valkey (any version)</li> </ul>"},{"location":"#how-it-works","title":"How It Works","text":""},{"location":"#sorted-set-queues","title":"Sorted Set Queues","text":"<p>Queues use Redis sorted sets instead of lists. Messages are added with <code>ZADD</code> using a score that encodes priority and timestamp. Workers use <code>BZMPOP</code> to atomically pop the highest-priority, oldest message.</p>"},{"location":"#message-persistence","title":"Message Persistence","text":"<p>Messages are stored in per-message hashes before being added to the queue. When consumed, the hash persists until explicitly acknowledged. Combined with visibility timeout tracking, this ensures messages are never lost - even if a worker crashes in the instant after the message is pop'ed from the queue, the message can be recovered and requeued.</p>"},{"location":"#delayed-delivery","title":"Delayed Delivery","text":"<p>Delayed messages are stored in a sorted set with timestamps as scores. A background thread periodically checks for messages whose timestamp has passed and moves them to the normal queue.</p>"},{"location":"#stream-based-fanout","title":"Stream-based Fanout","text":"<p>Fanout exchanges use Redis Streams. Messages are added with <code>XADD</code>, and each consumer uses <code>XREAD</code> tracking their own position. Old messages are trimmed based on <code>stream_maxlen</code>.</p>"},{"location":"#contributing","title":"Contributing","text":"<p>This package is intended as a temporary solution until these improvements are merged upstream into Celery/Kombu. Contributions are welcome! For consulting inquiries, contact ohaas@e1plus.de.</p>"},{"location":"#license","title":"License","text":"<p>MIT License - see LICENSE for details.</p>"},{"location":"getting-started/installation/","title":"Installation","text":""},{"location":"getting-started/installation/#requirements","title":"Requirements","text":"<ul> <li>Python &gt;= 3.13</li> <li>Celery &gt;= 5.5.0</li> <li>Redis &gt;= 7.0 (for BZMPOP) or Valkey (any version)</li> </ul>"},{"location":"getting-started/installation/#install-with-uv","title":"Install with uv","text":"<pre><code>uv add celery-redis-plus\n</code></pre>"},{"location":"getting-started/installation/#install-with-pip","title":"Install with pip","text":"<pre><code>pip install celery-redis-plus\n</code></pre>"},{"location":"getting-started/installation/#development-installation","title":"Development Installation","text":"<pre><code># Clone the repository\ngit clone https://github.com/oliverhaas/celery-redis-plus.git\ncd celery-redis-plus\n\n# Create virtual environment and install with development dependencies\nuv venv\nuv sync --group dev\n\n# Run tests (requires Docker for integration tests)\nuv run pytest\n\n# Run linter\nuv run ruff check\n\n# Run type checker\nuv run ty check\n</code></pre>"},{"location":"getting-started/quickstart/","title":"Quick Start","text":""},{"location":"getting-started/quickstart/#basic-setup","title":"Basic Setup","text":"<pre><code>from celery import Celery\nfrom celery_redis_plus import DelayedDeliveryBootstep\n\napp = Celery('myapp')\napp.config_from_object({\n    'broker_url': 'celery_redis_plus.transport:Transport://localhost:6379/0',\n})\napp.steps['consumer'].add(DelayedDeliveryBootstep)\n\n@app.task\ndef my_task():\n    print(\"Hello!\")\n\n# Tasks with countdown/eta will use native Redis delayed delivery\nmy_task.apply_async(countdown=120)\n\n# Priority support (RabbitMQ semantics: higher = more important)\nmy_task.apply_async(priority=90)   # High priority\nmy_task.apply_async(priority=0)    # Low priority (default)\n</code></pre>"},{"location":"getting-started/quickstart/#configuration","title":"Configuration","text":""},{"location":"getting-started/quickstart/#transport-options","title":"Transport Options","text":"<p>Configure via Celery's <code>broker_transport_options</code>:</p> <pre><code>app.config_from_object({\n    'broker_url': 'celery_redis_plus.transport:Transport://localhost:6379/0',\n    'broker_transport_options': {\n        'global_keyprefix': 'myapp:',        # Prefix for all Redis keys\n        'visibility_timeout': 300,          # Seconds before unacked messages are reclaimed\n        'stream_max_length': 10000,          # Max messages per stream (approximate)\n    },\n})\n</code></pre>"},{"location":"getting-started/quickstart/#ssltls-connections","title":"SSL/TLS Connections","text":"<p>For secure connections to Redis, use the <code>ssl</code> transport option:</p> <pre><code>app.config_from_object({\n    'broker_url': 'celery_redis_plus.transport:Transport://localhost:6379/0',\n    'broker_transport_options': {\n        'ssl': True,  # Use default SSL settings\n    },\n})\n\n# Or with custom SSL options:\nimport ssl\napp.config_from_object({\n    'broker_url': 'celery_redis_plus.transport:Transport://localhost:6379/0',\n    'broker_transport_options': {\n        'ssl': {\n            'ssl_cert_reqs': ssl.CERT_REQUIRED,\n            'ssl_ca_certs': '/path/to/ca.crt',\n            'ssl_certfile': '/path/to/client.crt',\n            'ssl_keyfile': '/path/to/client.key',\n        },\n    },\n})\n</code></pre>"},{"location":"reference/api/","title":"API Reference","text":""},{"location":"reference/api/#transport","title":"Transport","text":""},{"location":"reference/api/#celery_redis_plustransport","title":"<code>celery_redis_plus.Transport</code>","text":"<p>Custom transport with sorted set queues, priority encoding, delayed delivery, and Redis Streams fanout.</p> <p>Usage:</p> <pre><code>app.config_from_object({\n    'broker_url': 'celery_redis_plus.transport:Transport://localhost:6379/0',\n})\n</code></pre> <p>Features:</p> <ul> <li>Sorted set queues with <code>BZMPOP</code> for atomic consumption</li> <li>Full 256-level priority support (0-255, higher = more important)</li> <li>Native delayed delivery using sorted set timestamps</li> <li>Redis Streams for reliable fanout messaging</li> </ul>"},{"location":"reference/api/#bootstep","title":"Bootstep","text":""},{"location":"reference/api/#celery_redis_plusdelayeddeliverybootstep","title":"<code>celery_redis_plus.DelayedDeliveryBootstep</code>","text":"<p>Worker bootstep for background message processing and recovery.</p> <p>Usage:</p> <pre><code>from celery_redis_plus import DelayedDeliveryBootstep\n\napp.steps['consumer'].add(DelayedDeliveryBootstep)\n</code></pre> <p>Responsibilities:</p> <ul> <li>Background thread for checking and delivering delayed messages</li> <li>Recovery of messages that exceeded visibility timeout</li> <li>Cleanup of expired message hashes</li> </ul>"},{"location":"reference/api/#configuration-options","title":"Configuration Options","text":""},{"location":"reference/api/#broker_transport_options","title":"<code>broker_transport_options</code>","text":"Option Type Default Description <code>global_keyprefix</code> <code>str</code> <code>\"\"</code> Prefix for all Redis keys <code>visibility_timeout</code> <code>int</code> <code>300</code> Seconds before unacked messages are reclaimed <code>stream_max_length</code> <code>int</code> <code>10000</code> Max messages per stream (approximate) <code>ssl</code> <code>bool</code> or <code>dict</code> <code>None</code> SSL/TLS configuration"},{"location":"reference/api/#redis-keys","title":"Redis Keys","text":"<p>The transport uses the following Redis key patterns:</p> Pattern Type Description <code>queue:{name}</code> Sorted Set Queue storing delivery tags with priority+timestamp scores <code>message:{delivery_tag}</code> Hash Message payload, routing key, priority, and flags <code>messages_index</code> Sorted Set Tracks <code>{delivery_tag: queue_at}</code> for visibility timeout and delayed delivery <code>/{db}.{exchange}</code> Stream Fanout messages <code>_kombu.binding.{exchange}</code> Set Queue-exchange bindings"},{"location":"reference/changelog/","title":"Changelog","text":"<p>All notable changes to this project will be documented in this file.</p> <p>The format is based on Keep a Changelog, and this project adheres to Semantic Versioning.</p>"},{"location":"reference/changelog/#unreleased","title":"[Unreleased]","text":""},{"location":"reference/changelog/#022-2025-01-22","title":"[0.2.2] - 2025-01-22","text":""},{"location":"reference/changelog/#changed","title":"Changed","text":"<ul> <li>Updated celery-types-ng to 0.25.4 and fixed typing errors</li> </ul>"},{"location":"reference/changelog/#021-2025-01-21","title":"[0.2.1] - 2025-01-21","text":""},{"location":"reference/changelog/#changed_1","title":"Changed","text":"<ul> <li>Added <code>queue:</code> prefix to avoid collision with list-based queues</li> </ul>"},{"location":"reference/changelog/#020-2025-01-20","title":"[0.2.0] - 2025-01-20","text":""},{"location":"reference/changelog/#added","title":"Added","text":"<ul> <li>Native delayed delivery support</li> <li>Full priority support (0-255)</li> <li>Reliable fanout via Redis Streams</li> <li>Visibility timeout tracking</li> </ul>"},{"location":"reference/changelog/#changed_2","title":"Changed","text":"<ul> <li>Switched from Redis lists to sorted sets for queues</li> <li>Improved message reliability with per-message hashes</li> </ul>"},{"location":"reference/changelog/#010-2025-01-15","title":"[0.1.0] - 2025-01-15","text":""},{"location":"reference/changelog/#added_1","title":"Added","text":"<ul> <li>Initial release</li> <li>Custom Kombu transport for Redis/Valkey</li> <li>Basic queue operations with sorted sets</li> </ul>"}]}